set -g default-terminal "tmux-256color"
set -g set-titles on
set -g set-titles-string "#T"
set -g history-limit 50000
set -sg escape-time 5
set -g focus-events on
setw -g aggressive-resize on
set -g renumber-windows on
set -g base-index 1
set -g monitor-bell on
set -g bell-action any
set -g extended-keys on
set -g extended-keys-format csi-u

# Turn on vi bindings in copy mode
set -g status-keys vi
set-window-option -g mode-keys vi
unbind-key -T copy-mode-vi v
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi 'C-v' send -X rectangle-toggle # For some reason you have to press space after??
bind -T copy-mode-vi 'y' send -X copy-selection
bind v copy-mode

# OSC 52
set -as terminal-features ',screen-256color:clipboard'
set -s set-clipboard on
set -g allow-passthrough on
set -ga update-environment TERM
set -ga update-environment TERM_PROGRAM

set -g pane-border-lines single
set -g pane-border-style fg=black
set -g pane-active-border-style fg=black,bright

# Keys
bind b set -g status
bind a send-prefix
bind r source-file ~/.config/tmux/tmux.conf
bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R
bind f resize-pane -Z
bind Tab last-window
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"
bind C command-prompt -p "New window:" "new-window -c '#{pane_current_path}' -n '%%'"
unbind-key d
bind d confirm-before -p "Detach session? Consider creating a new window instead. (y/n)" detach-client
bind X confirm-before -p "Kill session?" kill-session
bind C-j copy-mode \; send-keys j
bind C-k copy-mode \; send-keys k

bind S command-prompt -p "New session:" "new-session -A -s '%%'"
bind s display-popup -E "tmux list-sessions | sed -E 's/:.*$//' | grep -v \"^$(tmux display-message -p '#S')\$\" | fzf --reverse | xargs tmux switch-client -t"
bind w display-popup -E "tmux list-windows -F \"#I:#W\" | fzf | cut -d \":\" -f 1 | xargs tmux select-window -t"
bind f display-popup -E "tmux-sessions"

bind -n M-1 select-window -t :1
bind -n M-2 select-window -t :2
bind -n M-3 select-window -t :3
bind -n M-4 select-window -t :4
bind -n M-5 select-window -t :5
bind -n M-6 select-window -t :6
bind -n M-7 select-window -t :7
bind -n M-8 select-window -t :8
bind -n M-9 select-window -t :9
bind -n C-M-h swap-window -t -1\; prev
bind -n C-M-l swap-window -t +1\; next
bind -n M-h previous-window
bind -n M-l next-window

bind -n M-n run-shell "tmux-napkin"
bind "e" {
  capture-pane -S -
  save-buffer /tmp/tmux_buffer_tmp
  delete-buffer
  send-keys 'nvim /tmp/tmux_buffer_tmp' Enter
}

# Status bar
# Only show when there is more than one window
set-hook -g after-new-window[0]      'if "[ #{session_windows} -gt 1 ]" "set status on"'
set-hook -g after-kill-pane[0]       'if "[ #{session_windows} -lt 2 ]" "set status off"'
set-hook -g pane-exited[0]           'if "[ #{session_windows} -lt 2 ]" "set status off"'
set-hook -g window-layout-changed[0] 'if "[ #{session_windows} -lt 2 ]" "set status off"'

# Name session after window list
# set-hook -g window-renamed[0]       "run-shell 'tmux-rename-session #{session_id}'"
# set-hook -g after-new-window[1]     "run-shell 'tmux-rename-session #{session_id}'"
# # set-hook -g after-kill-window    "run-shell 'tmux-rename-session #{session_id}'"
# set-hook -g after-kill-pane[1]      "run-shell 'tmux-rename-session #{session_id}'"
# set-hook -g after-select-window[0]  "run-shell 'tmux-rename-session #{session_id}'"

set -g status off
set -g status-position top
set -g status-justify absolute-centre
set -g status-style "fg=Colour8 bg=Colour237"
set -g status-left "#S"
set -g status-right ""
set -g window-status-current-style "fg=Colour7"
set -g window-status-current-format '#W'
set -g window-status-format '#W'
set -g window-status-separator " â€¢ "
set -g window-status-bell-style "fg=Colour1"

# Plugins
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-yank'
set -g @plugin 'wfxr/tmux-fzf-url'

if "test ! -d $XDG_DATA_HOME/tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm $XDG_DATA_HOME/tmux/plugins/tpm && $XDG_DATA_HOME/tmux/plugins/tpm/bin/install_plugins'"

run '$XDG_DATA_HOME/tmux/plugins/tpm/tpm'
